<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Trips</title>

    <!-- VUE -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Axios and API -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqbv7BqX1_7CcpPT80locaYJ3fnsdC-Sg&libraries=places"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Pacifico&family=Playwrite+GB+S:ital,wght@0,100..400;1,100..400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="navbar.css">
    <link rel = "stylesheet" href = "mytripinfo.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</head>
<body>

    <div>
        <div id="navbar-app">
            <navbar-component></navbar-component>
        </div>
    
        <script src = "navbarLoader.js"></script>
    </div>

    <div id="app">
        <div class="header">
            <div class="header-title">Trip to {{ destination }}</div>
            {{ formatDate(startDate) }} - {{ formatDate(endDate) }}
            <div class="nav-buttons">
                <button class="btn" @click="navigateToHotels">Hotels</button>
                <button class="btn" @click="navigateToAttractions">Attractions</button>
                <button class="btn" @click="navigateToAddFlightInfo">Flights</button>
            </div>
        </div>

        <div class="trip-container">        
            <div class="itinerary-section">
                <h2>Trip Itinerary</h2>
                <div v-if="days.length === 0 || !days.some(day => day.activities.length > 0)" class="center-message">
                    <p>Click "Attractions" or "Hotels" to start!</p>
                </div>
                <div v-for="day in days" :key="day.id" class="day-card">
                    <div class="day-header">
                        <h3>{{ day.date }}</h3>
                        <!-- <span class="day-date">{{ day.date }}</span> -->
                    </div>
                    <div v-for="activity in day.activities" :key="activity.id" class="activity-item">
                        <span class="activity-time">{{ activity.formattedTime }}</span>
                        <div class="activity-details">
                            <span>{{ activity.description }}</span>
                            <span class="activity-type">{{ activity.type }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Flight Details Sidebar -->
            <div class="flight-section">
                <h2>Flight Details</h2>
                <div v-if="flights.length === 0" class="center-message">
                    <p>Click on "Flights" to add your flight to the trip!</p>
                </div>
                <div v-for="flight in flights" :key="flight.flight_no" class="flight-card">
                    <div class="flight-header">
                        <span class="flight-type">{{ formatDate(flight.departure_date) }}</span>
                        <span class="flight-type">{{ flight.flight_no }}</span>
                    </div>
                    <div class="flight-header">
                        <span class="flight-type">{{ flight.departure_time }}</span>
                        <!-- Only show Seat No if available -->
                        <span v-if="flight.seat_no" class="flight-type">Seat: {{ flight.seat_no }}</span>
                    </div> 
                    <div class="flight-details">
                        <div class="flight-city">
                            <div><strong>{{ flight.departure_city }}</strong></div>
                        </div>
                        <div class="flight-arrow">â†’</div>
                        <div class="flight-city">
                            <div><strong>{{ flight.arrival_city }}</strong></div>
                        </div>
                    </div>
                </div>

                <h2>Remaining Budget</h2>
                <div class="budget-section">
                    <div class="budget-header">
                        <h3 :style="{ color: remainingBudgetColor }">${{ remainingBudgetCalc.toFixed(2) }}</h3>
                        <!-- Budget Progress Bar -->
                        <div class="budget-progress">
                            <div 
                                class="budget-bar" 
                                :style="{ 
                                    width: budgetBarWidth, 
                                    backgroundColor: budgetBarColor 
                                }">
                            </div>
                        </div>
                        <h5>Total Spent:</h5>
                        <h5> <strong>${{ totalSpent.toFixed(2) }}</strong> / ${{ budget.total.toFixed(2) }}</h5>
                    </div>
                    <div class="budget-details">
                        <div class="budget-row">
                            <span><h5>Hotels:</h5></span>
                            <span>${{ budget.hotels.toFixed(2) }}</span>
                        </div>
                        <div class="budget-row">
                            <span><h5>Flights:</h5></span>
                            <span>${{ budget.flights.toFixed(2) }}</span>
                        </div>
                        <div class="budget-row">
                            <span><h5>Activities:</h5></span>
                            <span>${{ budget.activities.toFixed(2) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Section -->
            <div class="budget-section">
                {{days}}
            </div>
        </div>
    </div>

    <footer>
        &copy; 2024 ROAMEO. All Rights Reserved.
    </footer>

    <script src="navbarLoader.js"></script>

    <script type="module">
        import { getFirestore, doc, getDoc, getDocs, collection, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { firebaseApp } from "./stuff.js";
        
        const db = getFirestore(firebaseApp);

        const app = Vue.createApp({
            data() {
                return {
                    userID: null,
                    trips: [],
                    days: [],
                    flights: [],
                    destination: '',
                    budget: {
                        total: 0,
                        hotels: 0,
                        flights: 0,
                        activities: 0
                    },
                    remainingBudget: 0,
                    startDate: '',
                    endDate: '',
                    tripID: null
                };
            },
            async mounted() {
                this.userID = await this.getUserID(); // Fetch the user ID after authentication
                if (this.userID) {
                    this.loadUserTrips();
                }
                this.getTripIDFromURL();
            },
            computed: {
                totalSpent() {
                    return this.budget.flights + this.budget.hotels + this.budget.activities;
                },
                remainingBudgetCalc() {
                    return this.budget.total - this.totalSpent;
                },
                remainingBudgetPercentage() {
                    if (this.budget.total === 0) {
                        return 0; // Avoid division by zero
                    }
                    return (this.remainingBudgetCalc / this.budget.total) * 100;
                },
                budgetBarWidth() {
                    return `${Math.max(this.remainingBudgetPercentage, 0).toFixed(2)}%`; // Ensure at least 0%
                },
                budgetBarColor() {
                    if (this.remainingBudgetPercentage >= 50) {
                        return '#4CAF50'; // Green
                    } else if (this.remainingBudgetPercentage >= 15) {
                        return '#FFA500'; // Orange
                    } else {
                        return '#dc3545'; // Red
                    }
                },
                remainingBudgetColor() {
                    if (this.remainingBudgetPercentage >= 50) {
                        return '#28a745'; // Green
                    } else if (this.remainingBudgetPercentage >= 15) {
                        return '#FFA500'; // Orange
                    } else {
                        return '#dc3545'; // Red
                    }
                }
            },
            methods: {
                getTripIDFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.tripID = urlParams.get('tripID');
                    console.log("Current tripID from URL:", this.tripID); // Log for debugging
                },

                navigateToAttractions() {
                    if (this.tripID) {
                        window.location.href = `attractions.html?tripID=${this.tripID}`;
                    }
                },

                navigateToHotels() {
                    if (this.tripID) {
                        window.location.href = `hotels.html?tripID=${this.tripID}`;
                    } 
                },

                navigateToAddFlightInfo() {
                    if (this.tripID) {
                        window.location.href = `addflightinfo.html?tripID=${this.tripID}`;
                    } else {
                        console.error("Trip ID is not available.");
                    }
                },

                formatDate(dateString) {
                    const options = { year: 'numeric', month: 'short', day: '2-digit' };
                    const date = new Date(dateString); // Convert string to Date object
                    return date.toLocaleDateString('en-GB', options); // 'en-GB' formats as 'dd mmm yyyy'
                },

                groupAndSortActivities(activities) {
                    // Helper function to format date
                    const formatDate = (timestamp) => {
                        const date = new Date(timestamp * 1000);
                        return date.toLocaleDateString('en-GB', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                        });
                    };

                    // Helper function to format time
                    const formatTime = (timestamp) => {
                        const date = new Date(timestamp * 1000);
                        return date.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true,
                        });
                    };

                    // Group activities by date
                    const grouped = activities.reduce((acc, activity) => {
                        const formattedDate = formatDate(activity.dateTime.seconds);
                        if (!acc[formattedDate]) {
                            acc[formattedDate] = [];
                        }
                        acc[formattedDate].push({
                            ...activity,
                            formattedTime: formatTime(activity.dateTime.seconds),
                        });
                        return acc;
                    }, {});

                    // Sort each group by time
                    Object.keys(grouped).forEach((date) => {
                        grouped[date].sort((a, b) => a.dateTime.seconds - b.dateTime.seconds);
                    });

                    return grouped;
                },

                // Get the UID of the logged-in user
                async getUserID() {
                    const auth = getAuth(firebaseApp);
                    return new Promise((resolve, reject) => {
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                resolve(user.uid);
                            } else {
                                window.location.href = 'index.html'; // Redirect if no user is signed in
                                reject("No user signed in");
                            }
                        });
                    });
                },

                // Load the user's trips from Firestore
                async loadUserTrips() {
                    const userRef = doc(db, "users", this.userID);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const tripIDs = userSnap.data().trips;
                        for (const tripID of tripIDs) {
                            const tripData = await this.fetchTripData(tripID);
                            this.trips.push(tripData);
                        }
                    }
                },

                // Fetch a specific trip's data by ID
                async fetchTripData(tripID) {
                    const tripRef = doc(db, "trips", tripID);
                    const tripSnap = await getDoc(tripRef);
                    if (tripSnap.exists()) {
                        const tripData = tripSnap.data();

                        // Log all the trip data here to see everything retrieved
                        console.log("Fetched trip data for tripID:", tripID);
                        console.log(tripData); // This will show the entire data object from Firestore

                
                        this.startDate = tripData.startdate;
                        this.endDate = tripData.enddate;
                        this.destination = tripData.destination;
                        this.budget.total = tripData.budget || 0;
                        
                        // Initialize the list of activities (hotels + attractions)
                        let activities = [];

                        // Map hotels to activities
                        if (tripData.hotels && tripData.hotels.length > 0) {
                            activities.push(...tripData.hotels.map(hotel => ({
                                type: "Hotel Check-In",
                                description: hotel.h_name,
                                dateTime: hotel.checkin,
                                cost: hotel.cost
                            })));
                        }

                        // Map attractions to activities
                        if (tripData.attractions && tripData.attractions.length > 0) {
                            activities.push(...tripData.attractions.map(attraction => ({
                                type: "Activity",
                                description: attraction.a_name,
                                dateTime: attraction.date,
                                cost: attraction.cost
                            })));
                        }

                        // Sort activities by date/time
                        activities.sort((a, b) => new Date(a.date) - new Date(b.date));

                        console.log('Activities before grouping:', activities);

                        // Group activities by day
                        let groupedDays = this.groupAndSortActivities(activities);
                        console.log('Grouped Days:', groupedDays);

                        // Update the days data property
                        this.days =  Object.keys(groupedDays).map(date => ({
                            date, // e.g., "13 Nov 2024"
                            activities: groupedDays[date] // Array of activities for that day
                        }));

                        this.flights = tripData.flights || [];
                        this.budget.flights = this.flights.reduce((sum, flight) => sum + parseFloat(flight.flight_cost || 0), 0);

                        this.budget.hotels = tripData.hotels
                            ? tripData.hotels.reduce((sum, hotel) => sum + (hotel.cost || 0), 0)
                            : 0;

                        this.budget.activities = tripData.attractions
                            ? tripData.attractions.reduce((sum, activity) => sum + (activity.cost || 0), 0)
                            : 0;

                        // this.trips.push(tripDetails);
                        
                        // return tripDetails;
                    } else {
                        console.error("No such trip found");
                    }
                }
            }
        });

        app.mount('#app');
    </script>

</body>
</html>