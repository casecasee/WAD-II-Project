<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Trips</title>

    <!-- VUE -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios and API -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBqbv7BqX1_7CcpPT80locaYJ3fnsdC-Sg&libraries=places"></script>

    <!-- CSS -->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> -->
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Pacifico&family=Playwrite+GB+S:ital,wght@0,100..400;1,100..400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="mytripinfo.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>


</head>

<body>

    <div>
        <div id="navbar-app">
            <navbar-component></navbar-component>
        </div>

        <script src="navbarLoader.js"></script>
    </div>

    <div id="app">
        <div class="header">
            <div class="header-title">Trip to {{ destination }}</div>
            {{ formatDate(startDate) }} - {{ formatDate(endDate) }}
            <div class="nav-buttons">
                <button class="btn" @click="navigateToHotels">Hotels</button>
                <button class="btn" @click="navigateToAttractions">Attractions</button>
                <button class="btn" @click="navigateToAddFlightInfo">Flights</button>
            </div>
        </div>

        <div class="trip-container">
            <div class="itinerary-section">
                <h2>Trip Itinerary</h2>
                <div class="day-card">
                    <div class="day-header">
                        <h3>Hotels</h3>
                    </div>
                    <div v-if="hotels.length === 0" class="center-message-hotel">
                        <p>Click "Hotels" to add!</p>
                    </div>
                    <div v-for="hotel in hotels" class="hotel-item">
                        <div class="hotel-name">{{ hotel.description }} </div>
                        <div class="hotel-type"><b>Check In: </b>{{hotel.formattedCheckin}}</div>
                        <div class="hotel-type"><b>Check out: </b>{{hotel.formattedCheckout}}</div>
                    </div>
                </div>

                <div v-if="days.length === 0 || !days.some(day => day.activities.length > 0)" class="center-message">
                    <p>Click "Attractions" to start!</p>
                </div>
                <div v-for="day in days" :key="day.id" class="day-card">
                    <div class="day-header">
                        <h3>{{ day.date }}</h3>
                        <!-- <span class="day-date">{{ day.date }}</span> -->
                    </div>
                    <div v-for="activity in day.activities" :key="activity.activityId" class="activity-item">
                        <span class="activity-time">{{ activity.formattedTime }}</span>
                        <div class="activity-details">
                            <span>{{ activity.description }}</span>
                            <span class="activity-type">{{ activity.type }}</span>
                            <span class="delete-cross"
                                @click="deleteActivity(tripID, activity.activityId)">&#10006;</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end;">
                        <button class="add-attract" @click="setAttractDate(day.date)">+ Attraction</button>
                    </div>
                </div>
            </div>

            <!-- Flight Details Sidebar -->
            <div class="flight-section">
                <h2>Flight Details</h2>
                <div v-if="flights.length === 0" class="center-message">
                    <p>Click on "Flights" to add your flight to the trip!</p>
                </div>
                <div v-for="flight in flights" :key="flight.flight_no" class="flight-card">
                    <div class="flight-header">
                        <span class="flight-type">{{ formatDate(flight.departure_date) }}</span>
                        <span class="flight-type">{{ flight.flight_no }}</span>
                    </div>
                    <div class="flight-header">
                        <span class="flight-type">{{ flight.departure_time }}</span>
                        <!-- Only show Seat No if available -->
                        <span v-if="flight.seat_no" class="flight-type">Seat: {{ flight.seat_no }}</span>
                    </div>
                    <div class="flight-details">
                        <div class="flight-city">
                            <div><strong>{{ flight.departure_city }}</strong></div>
                        </div>
                        <div class="flight-arrow">â†’</div>
                        <div class="flight-city">
                            <div><strong>{{ flight.arrival_city }}</strong></div>
                        </div>
                    </div>
                </div>

                <h2>Remaining Budget</h2>
                <div class="budget-section">

                    <div class="budget-header">
                        <h3 :style="{ color: remainingBudgetColor }">${{ remainingBudgetCalc.toFixed(2) }}</h3>
                        <!-- Budget Progress Bar -->
                        <div class="budget-progress">
                            <div class="budget-bar" :style="{ 
                                    width: budgetBarWidth, 
                                    backgroundColor: budgetBarColor 
                                }">
                            </div>
                        </div>
                        <h5>Total Spent:</h5>
                        <h5> <strong>${{ totalSpent.toFixed(2) }}</strong> / ${{ budget.total.toFixed(2) }}</h5>
                    </div>
                    <div class="budget-details">
                        <div class="budget-row">
                            <span>
                                <h5>Hotels:</h5>
                            </span>
                            <span>${{ budget.hotels.toFixed(2) }}</span>
                        </div>
                        <div class="budget-row">
                            <span>
                                <h5>Flights:</h5>
                            </span>
                            <span>${{ budget.flights.toFixed(2) }}</span>
                        </div>
                        <div class="budget-row">
                            <span>
                                <h5>Activities:</h5>
                            </span>
                            <span>${{ budget.activities.toFixed(2) }}</span>
                        </div>
                    </div>
                </div>
                <h2>Weather</h2>

                <div class="weather-section"
                    :style="{background: isDaytime ? 'lightblue' : isSunset || isSunrise ? 'linear-gradient(to bottom, purple, orange)' : 'rgb(41, 41, 41)', color: isDaytime || isSunset || isSunrise ? 'black' : 'white'}">
                    <div class="currentTemp">
                        <div class="location">
                            <span><b>{{destination}}</b></span>
                            <span>
                                <i :class="isDaytime ? 'fas fa-sun' : 'fas fa-moon'" style="font-size:20px"></i>
                            </span>
                        </div>
                        <span class="temp">
                            <i :class="temperatureIcon" style='font-size:36px'></i>
                            {{ temperature }}
                        </span>
                        <div class="locweather">
                            {{weather}}
                        </div>
                        <div class="datetime">
                            <strong>Last updated:</strong> {{ time }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Section -->
        <div class="news-section">
            <h2>Latest news in {{ destination }}</h2>
            {{userID}}
        </div>
    </div>
    </div>

    <footer>
        &copy; 2024 ROAMEO. All Rights Reserved.
    </footer>

    <script src="navbarLoader.js"></script>

    <script type="module">

        import { getFirestore, doc, getDoc, getDocs, collection, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { firebaseApp } from "./stuff.js";

        const db = getFirestore(firebaseApp);

        const app = Vue.createApp({
            data() {
                return {
                    userID: null,
                    hotels: [],
                    trips: [],
                    days: [],
                    flights: [],
                    destination: '',
                    budget: {
                        total: 0,
                        hotels: 0,
                        flights: 0,
                        activities: 0
                    },
                    remainingBudget: 0,
                    startDate: '',
                    endDate: '',
                    tripID: null,
                    latitude: null,
                    longitude: null,
                    weather: 'broken clouds',
                    temperature: '-21Â°C',
                    humidity: '88%',
                    time: null,
                    isDaytime: null,
                    isSunset: null,
                    isSunrise: null
                };
            },
            // async mounted() {
            //     this.userID = await this.getUserID(); // Fetch the user ID after authentication
            //     console.log("User ID:", this.userID);  // Log the userID

            //     if (this.userID) {
            //         this.loadUserTrips();
            //     }
            //     this.getTripIDFromURL(); // this function sets both country and tripid
            // },

            async mounted() {
                // Set tripID and country before loading trips
                this.getTripIDFromURL();

                this.userID = await this.getUserID(); // Get the user ID after authentication
                console.log("User ID:", this.userID);  // Log the userID

                if (this.userID) {
                    await this.fetchTripData(this.tripID);  // Get the specific trip data
                    await this.fetchWeatherDetails(this.destination); // Fetch coordinates for the destination
                }
            },

            computed: {
                temperatureIcon() {
                    const tempValue = parseFloat(this.temperature);
                    return tempValue >= 20
                        ? 'fas fa-temperature-high'
                        : 'fas fa-temperature-low';
                },
                totalSpent() {
                    return this.budget.flights + this.budget.hotels + this.budget.activities;
                },
                remainingBudgetCalc() {
                    return this.budget.total - this.totalSpent;
                },
                remainingBudgetPercentage() {
                    if (this.budget.total === 0) {
                        return 0; // Avoid division by zero
                    }
                    return (this.remainingBudgetCalc / this.budget.total) * 100;
                },
                budgetBarWidth() {
                    return `${Math.max(this.remainingBudgetPercentage, 0).toFixed(2)}%`; // Ensure at least 0%
                },
                budgetBarColor() {
                    if (this.remainingBudgetPercentage >= 50) {
                        return '#4CAF50'; // Green
                    } else if (this.remainingBudgetPercentage >= 15) {
                        return '#FFA500'; // Orange
                    } else {
                        return '#dc3545'; // Red
                    }
                },
                remainingBudgetColor() {
                    if (this.remainingBudgetPercentage >= 50) {
                        return '#28a745'; // Green
                    } else if (this.remainingBudgetPercentage >= 15) {
                        return '#FFA500'; // Orange
                    } else {
                        return '#dc3545'; // Red
                    }
                }
            },
            methods: {
                setAttractDate(date) {
                    // Store the selected date in localStorage
                    localStorage.setItem('attract_date', date);

                    // Optionally navigate to the attractions page after setting the date
                    this.navigateToAttractions();
                },

                getTripIDFromURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.tripID = localStorage.getItem('tripID')
                    this.country = urlParams.get('country')
                    console.log("Current tripID from URL:", this.tripID); // Log for debugging
                },

                navigateToAttractions() {
                    if (this.tripID) {
                        window.location.href = `attractionImages.html?country=${this.country}`;
                    }
                },

                navigateToHotels() {
                    if (this.tripID) {
                        // Store the country in localStorage before navigating
                        localStorage.setItem('selectedCountry', this.country);
                        window.location.href = `hotels.html?country=${this.country}`;
                    }
                },

                navigateToAddFlightInfo() {
                    if (this.tripID) {
                        window.location.href = `addflightinfo.html?country=${this.country}`;
                    } else {
                        console.error("Trip ID is not available.");
                    }
                },

                formatDate(dateString) {
                    const options = { year: 'numeric', month: 'short', day: '2-digit' };
                    const date = new Date(dateString); // Convert string to Date object
                    return date.toLocaleDateString('en-GB', options); // 'en-GB' formats as 'dd mmm yyyy'
                },

                fetchWeatherDetails(q) {
                    const URL = "https://api.openweathermap.org/data/2.5/weather";
                    const apikey = "-";

                    axios.get(URL, {
                        params: {
                            // lat: lat,
                            // lon: lon,
                            q: this.destination,
                            appid: apikey,
                            units: 'metric'  // Temperature in Celsius
                        }
                    })
                        .then(response => {
                            let weather = response.data.weather[0].description;
                            const humidity = response.data.main.humidity;
                            const temperature = response.data.main.temp;
                            const timestamp = response.data.dt;
                            const sunrise = response.data.sys.sunrise;
                            const sunset = response.data.sys.sunset;

                            const currentTime = new Date(timestamp * 1000);
                            const sunriseTime = new Date(sunrise * 1000);
                            const sunsetTime = new Date(sunset * 1000);

                            const formattedTime = currentTime.toLocaleString('en-GB', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true
                            });

                            const thirtyMinutesBeforeSunset = new Date(sunsetTime.getTime() - 30 * 60 * 1000);
                            const thirtyMinutesAfterSunset = new Date(sunsetTime.getTime() + 30 * 60 * 1000);
                            const thirtyMinutesBeforeSunrise = new Date(sunriseTime.getTime() - 30 * 60 * 1000);
                            const thirtyMinutesAfterSunrise = new Date(sunriseTime.getTime() + 30 * 60 * 1000);

                            const isDaytime = currentTime >= sunriseTime && currentTime <= sunsetTime;
                            const isSunset = currentTime >= thirtyMinutesBeforeSunset && currentTime <= thirtyMinutesAfterSunset;
                            const isSunrise = currentTime >= thirtyMinutesBeforeSunrise && currentTime <= thirtyMinutesAfterSunrise;
                            const isNighttime = !isDaytime && !isSunset && !isSunrise;


                            weather = weather.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                            this.weather = weather;
                            this.humidity = humidity + '%';
                            this.temperature = temperature + "Â°C";
                            this.time = formattedTime;  // Store formatted date and time
                            this.isDaytime = isDaytime;
                            this.isSunset = isSunset;
                            this.isSunrise = isSunrise;
                            this.isNighttime = isNighttime;

                            console.log(`Weather: ${weather}, Humidity: ${humidity}%, Temperature: ${temperature}Â°C`);
                        })
                        .catch(error => {
                            console.error("Error fetching weather details:", error.message);
                        });
                },

                // async getCoordinates(destination) {
                //     const apiKey = '9c376fe710bf456d8c57969019eecf63';
                //     const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(destination)}&type=country&apiKey=${apiKey}`;

                //     try {
                //         const response = await axios.get(url);
                //         const data = response.data;

                //         if (data && data.features && data.features.length > 0) {
                //             const firstResult = data.features[0];
                //             this.latitude = firstResult.geometry.coordinates[1];  // Latitude
                //             this.longitude = firstResult.geometry.coordinates[0]; // Longitude
                //             console.log(`Coordinates: Lat=${this.latitude}, Lon=${this.longitude}`);

                //             this.fetchWeatherDetails(this.latitude, this.longitude);
                //         } else {
                //             console.error("No results found for the destination.");
                //         }
                //     } catch (error) {
                //         console.error("Error fetching coordinates:", error);
                //     }
                // },

                groupAndSortActivities(activities) {
                    // Helper function to format date
                    const formatDate = (timestamp) => {
                        const date = new Date(timestamp * 1000);
                        return date.toLocaleDateString('en-GB', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                        });
                    };

                    // Helper function to format time
                    const formatTime = (timestamp) => {
                        const date = new Date(timestamp * 1000);
                        return date.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true,
                        });
                    };

                    // Group activities by date
                    const grouped = activities.reduce((acc, activity) => {
                        const formattedDate = formatDate(activity.dateTime.seconds);
                        if (!acc[formattedDate]) {
                            acc[formattedDate] = [];
                        }
                        acc[formattedDate].push({
                            ...activity,
                            formattedTime: formatTime(activity.dateTime.seconds),
                        });
                        return acc;
                    }, {});

                    // Sort each group by time
                    Object.keys(grouped).forEach((date) => {
                        grouped[date].sort((a, b) => a.dateTime.seconds - b.dateTime.seconds);
                        grouped[date] = grouped[date].map((activity, index) => ({
                            ...activity,
                            activityId: `${date}-${index}`, // Unique ID in the format date-index
                        }));
                    });

                    return grouped;
                },

                // Get the UID of the logged-in user
                async getUserID() {
                    const auth = getAuth(firebaseApp);
                    return new Promise((resolve, reject) => {
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                resolve(user.uid);
                            } else {
                                window.location.href = 'index.html'; // Redirect if no user is signed in
                                reject("No user signed in");
                            }
                        });
                    });
                },

                async deleteActivity(tripID, activityId) {
                    try {
                        const tripRef = doc(db, "trips", tripID);
                        const tripSnap = await getDoc(tripRef);

                        if (tripSnap.exists()) {
                            const tripData = tripSnap.data();
                            const attractions = tripData.attractions || [];

                            // Find the activity to delete based on the activityId
                            const activityIndex = attractions.findIndex(activity => activity.id === activityId);

                            if (activityIndex !== -1) {
                                // Remove the activity from the attractions array
                                attractions.splice(activityIndex, 1);

                                // Update the trip document with the modified attractions array
                                await updateDoc(tripRef, { attractions });

                                // Remove the activity from the days array in the local data
                                this.days.forEach(day => {
                                    const activityIndexInDay = day.activities.findIndex(activity => activity.id === activityId);
                                    if (activityIndexInDay !== -1) {
                                        day.activities.splice(activityIndexInDay, 1);  // Only remove this specific activity
                                    }
                                });

                                // Filter out days with no activities to prevent rendering empty day cards
                                this.days = this.days.filter(day => day.activities.length > 0);

                                console.log(`Activity with ID: ${activityId} has been deleted from the database and UI.`);
                                console.log(this.days); // After deleting the activity

                            } else {
                                console.log(`Activity with ID: ${activityId} not found in the attractions.`);
                            }
                        } else {
                            console.log("No trip found for the given trip ID.");
                        }
                    } catch (error) {
                        console.error("Error deleting activity from database:", error);
                    }
                },


                // Load the user's trips from Firestore
                async loadUserTrips() {
                    const userRef = doc(db, "users", this.userID);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const tripIDs = userSnap.data().trips;
                        for (const tripID of tripIDs) {
                            const tripData = await this.fetchTripData(tripID);
                            this.trips.push(tripData);
                        }
                    }
                },

                // Fetch a specific trip's data by ID
                async fetchTripData(tripID) {
                    const tripRef = doc(db, "trips", tripID);
                    const tripSnap = await getDoc(tripRef);
                    if (tripSnap.exists()) {
                        const tripData = tripSnap.data();

                        console.log("Fetched trip data for tripID:", tripID);
                        console.log(tripData);

                        this.startDate = tripData.startdate;
                        this.endDate = tripData.enddate;
                        this.destination = tripData.destination;
                        this.budget.total = tripData.budget || 0;

                        let activities = [];
                        let hotels = [];

                        // Map hotels to activities
                        if (tripData.hotels && tripData.hotels.length > 0) {
                            hotels = tripData.hotels.map(hotel => ({
                                type: "Hotel Check-In",
                                description: hotel.h_name,
                                checkIn: hotel.checkin,
                                checkOut: hotel.checkout,
                                cost: hotel.cost,
                                formattedCheckin: this.formatDate(hotel.checkin), // Format the check-in date
                                formattedCheckout: this.formatDate(hotel.checkout) // Format the check-in date
                            }));
                        }

                        // Sort hotels by the formatted checkin date
                        hotels.sort((a, b) => new Date(a.formattedCheckin) - new Date(b.formattedCheckin));
                        console.log("sorted hotels", hotels);
                        this.hotels = hotels;
                        console.log("test", this.hotels);


                        // Map attractions to activities
                        if (tripData.attractions && tripData.attractions.length > 0) {
                            activities.push(...tripData.attractions.map(attraction => ({
                                type: "Activity",
                                description: attraction.a_name,
                                dateTime: attraction.date,
                                cost: attraction.cost
                            })));
                        }

                        // Sort activities by date/time
                        activities.sort((a, b) => new Date(a.date) - new Date(b.date));

                        console.log('Activities before grouping:', activities);

                        // Group activities by day
                        let groupedDays = this.groupAndSortActivities(activities);
                        console.log('Grouped Days:', groupedDays);

                        // Update the days data property
                        this.days = Object.keys(groupedDays).map(date => ({
                            date, // e.g., "13 Nov 2024"
                            activities: groupedDays[date] // Array of activities for that day
                        }));
                        console.log(this.days)

                        this.flights = tripData.flights || [];
                        this.budget.flights = this.flights.reduce((sum, flight) => sum + parseFloat(flight.flight_cost || 0), 0);

                        this.budget.hotels = tripData.hotels
                            ? tripData.hotels.reduce((sum, hotel) => sum + (hotel.cost || 0), 0)
                            : 0;

                        this.budget.activities = tripData.attractions
                            ? tripData.attractions.reduce((sum, activity) => sum + (activity.cost || 0), 0)
                            : 0;

                        // this.trips.push(tripDetails);

                        // return tripDetails;
                    } else {
                        console.error("No such trip found");
                    }
                }
            }
        });

        app.mount('#app');
    </script>

</body>

</html>